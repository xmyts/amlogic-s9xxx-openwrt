include $(TOPDIR)/rules.mk

PKG_NAME:=libdeflate
PKG_VERSION:=1.22
PKG_RELEASE:=1

PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
PKG_SOURCE_URL:=https://github.com/ebiggers/libdeflate/releases/download/v$(PKG_VERSION)/
PKG_HASH:=7834d9adbc9a809e0fb0d7b486060a9ae5f7819eb7f55bb8c22b10d7b3bed8da

# 仅保留host编译所需的最小依赖
include $(INCLUDE_DIR)/host-build.mk

# 主机编译器配置
HOSTCC := $(HOSTCC_NOCACHE)
HOSTCXX := $(HOSTCXX_NOCACHE)

# 生成configure脚本（关键步骤）
define Host/Prepare
	mkdir -p $(HOST_BUILD_DIR)
	tar -xzf $(DL_DIR)/$(PKG_SOURCE) -C $(HOST_BUILD_DIR) --strip-components=1
	cd $(HOST_BUILD_DIR) && ./autogen.sh  # 生成configure
endef

# 配置host编译
define Host/Configure
	cd $(HOST_BUILD_DIR) && \
	./configure \
		--prefix=$(STAGING_DIR_HOST) \
		--libdir=$(STAGING_DIR_HOST)/lib \
		--enable-shared \
		--disable-static \
		--disable-armv83
endef

# 编译host工具
define Host/Compile
	$(MAKE) -C $(HOST_BUILD_DIR)
endef

# 安装host工具
define Host/Install
	$(MAKE) -C $(HOST_BUILD_DIR) install
endef

# 清理host编译文件
define Host/Clean
	rm -rf $(HOST_BUILD_DIR)
	rm -f $(STAGING_DIR_HOST)/bin/libdeflate-gzip
endef

# 注册host编译目标（必须放在最后）
$(eval $(call HostBuild))